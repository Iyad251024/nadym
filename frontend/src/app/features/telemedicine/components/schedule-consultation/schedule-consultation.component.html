<div class="page-header">
  <div class="container">
    <div class="header-actions">
      <button mat-icon-button (click)="onCancel()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-content">
        <h1>Programmer une téléconsultation</h1>
        <p>Planification de consultation vidéo</p>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="form-container">
    <form [formGroup]="consultationForm" (ngSubmit)="onSubmit()" *ngIf="!loading">
      <!-- Participants -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Participants</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Patient</mat-label>
              <mat-select formControlName="patientId">
                <mat-option *ngFor="let patient of patients" [value]="patient.id">
                  {{ patient.name }}, {{ patient.age }} ans
                </mat-option>
              </mat-select>
              <mat-error>{{ getErrorMessage('patientId') }}</mat-error>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Médecin</mat-label>
              <mat-select formControlName="doctorId">
                <mat-option *ngFor="let doctor of getAvailableDoctors()" [value]="doctor.id">
                  {{ doctor.name }} - {{ doctor.specialty }}
                </mat-option>
              </mat-select>
              <mat-error>{{ getErrorMessage('doctorId') }}</mat-error>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Consultation Details -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Détails de la consultation</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Type de consultation</mat-label>
              <mat-select formControlName="consultationType">
                <mat-option *ngFor="let type of consultationTypes" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
              <mat-error>{{ getErrorMessage('consultationType') }}</mat-error>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Durée</mat-label>
              <mat-select formControlName="duration">
                <mat-option *ngFor="let duration of durations" [value]="duration.value">
                  {{ duration.label }}
                </mat-option>
              </mat-select>
              <mat-error>{{ getErrorMessage('duration') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date</mat-label>
              <input matInput 
                     type="date" 
                     formControlName="date"
                     [min]="getMinDate()"
                     [max]="getMaxDate()">
              <mat-error>{{ getErrorMessage('date') }}</mat-error>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Heure</mat-label>
              <input matInput type="time" formControlName="time">
              <mat-error>{{ getErrorMessage('time') }}</mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Motif de consultation</mat-label>
            <textarea matInput formControlName="reason" rows="2" 
                      placeholder="Décrivez le motif de la consultation"></textarea>
            <mat-error>{{ getErrorMessage('reason') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes additionnelles</mat-label>
            <textarea matInput formControlName="notes" rows="3" 
                      placeholder="Notes pour la consultation (optionnel)"></textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Options -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Options</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="options-list">
            <mat-slide-toggle formControlName="sendReminder" color="primary">
              <span class="option-label">
                <mat-icon>notifications</mat-icon>
                Envoyer un rappel au patient
              </span>
              <small>Le patient recevra un email de rappel 24h avant</small>
            </mat-slide-toggle>
            
            <mat-slide-toggle formControlName="recordSession" color="primary">
              <span class="option-label">
                <mat-icon>videocam</mat-icon>
                Enregistrer la session
              </span>
              <small>La consultation sera enregistrée pour le dossier médical</small>
            </mat-slide-toggle>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Summary -->
      <mat-card class="summary-card" *ngIf="getSelectedPatient() && getSelectedDoctor()">
        <mat-card-header>
          <mat-card-title>Résumé de la consultation</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-info">
            <div class="summary-row">
              <mat-icon>person</mat-icon>
              <span><strong>Patient:</strong> {{ getSelectedPatient()?.name }}, {{ getSelectedPatient()?.age }} ans</span>
            </div>
            <div class="summary-row">
              <mat-icon>medical_services</mat-icon>
              <span><strong>Médecin:</strong> {{ getSelectedDoctor()?.name }}</span>
            </div>
            <div class="summary-row" *ngIf="formatDateTime()">
              <mat-icon>event</mat-icon>
              <span><strong>Date et heure:</strong> {{ formatDateTime() }}</span>
            </div>
            <div class="summary-row">
              <mat-icon>schedule</mat-icon>
              <span><strong>Durée:</strong> {{ consultationForm.get('duration')?.value }} minutes</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="form-actions">
        <button mat-button type="button" (click)="onCancel()">
          Annuler
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="consultationForm.invalid">
          <mat-icon>video_call</mat-icon>
          Programmer la consultation
        </button>
      </div>
    </form>

    <div class="loading-spinner" *ngIf="loading">
      <mat-spinner></mat-spinner>
      <p>Programmation en cours...</p>
    </div>
  </div>
</div>