<div class="page-header">
  <div class="container">
    <h1>Rapports d'observance</h1>
    <p>Analyse de l'adhérence thérapeutique des patients</p>
  </div>
</div>

<div class="container">
  <!-- Controls -->
  <div class="controls-section">
    <mat-form-field appearance="outline">
      <mat-label>Période</mat-label>
      <mat-select [(value)]="selectedPeriod" (selectionChange)="onPeriodChange()">
        <mat-option *ngFor="let period of periods" [value]="period.value">
          {{ period.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <button mat-raised-button color="accent" (click)="exportReport()">
      <mat-icon>download</mat-icon>
      Exporter
    </button>
  </div>

  <!-- Patient Summaries -->
  <div class="reports-grid">
    <mat-card *ngFor="let summary of patientSummaries" class="patient-summary-card">
      <mat-card-header>
        <mat-card-title>{{ summary.patientName }}</mat-card-title>
        <mat-card-subtitle>Dernière mise à jour: {{ formatDateTime(summary.lastUpdate) }}</mat-card-subtitle>
        <div class="card-actions">
          <mat-chip [color]="getRiskLevelColor(summary.riskLevel)" selected>
            {{ getRiskLevelLabel(summary.riskLevel) }}
          </mat-chip>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Overall Adherence -->
        <div class="overall-adherence">
          <div class="adherence-header">
            <h3>Observance globale</h3>
            <span class="adherence-percentage" [style.color]="getAdherenceColor(summary.overallAdherence) === 'warn' ? '#f44336' : '#4caf50'">
              {{ summary.overallAdherence }}%
            </span>
          </div>
          <mat-progress-bar 
            mode="determinate" 
            [value]="summary.overallAdherence"
            [color]="getAdherenceColor(summary.overallAdherence)">
          </mat-progress-bar>
        </div>
        
        <!-- Medication Details -->
        <div class="medications-detail">
          <h4>Détail par médicament</h4>
          <div class="medication-list">
            <div *ngFor="let med of summary.medications" class="medication-item">
              <div class="medication-info">
                <div class="medication-name">
                  <strong>{{ med.medicationName }}</strong>
                  <mat-icon [color]="getTrendColor(med.trend)" class="trend-icon">
                    {{ getTrendIcon(med.trend) }}
                  </mat-icon>
                </div>
                
                <div class="medication-stats">
                  <span class="stat">
                    <mat-icon>check_circle</mat-icon>
                    {{ med.takenDoses }}/{{ med.totalDoses }} prises
                  </span>
                  <span class="stat missed" *ngIf="med.missedDoses > 0">
                    <mat-icon>cancel</mat-icon>
                    {{ med.missedDoses }} manquées
                  </span>
                </div>
              </div>
              
              <div class="medication-adherence">
                <span class="adherence-rate">{{ med.adherenceRate }}%</span>
                <mat-progress-bar 
                  mode="determinate" 
                  [value]="med.adherenceRate"
                  [color]="getAdherenceColor(med.adherenceRate)">
                </mat-progress-bar>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button color="primary">
          <mat-icon>visibility</mat-icon>
          Voir détails
        </button>
        <button mat-button color="accent">
          <mat-icon>message</mat-icon>
          Contacter patient
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Summary Statistics -->
  <mat-card class="summary-stats-card">
    <mat-card-header>
      <mat-card-title>Statistiques générales</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item">
          <mat-icon>people</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ patientSummaries.length }}</span>
            <span class="stat-label">Patients suivis</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon>trending_up</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ (patientSummaries.reduce((sum, p) => sum + p.overallAdherence, 0) / patientSummaries.length).toFixed(0) }}%</span>
            <span class="stat-label">Observance moyenne</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon>warning</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ patientSummaries.filter(p => p.riskLevel === 'high').length }}</span>
            <span class="stat-label">Patients à risque</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon>check_circle</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ patientSummaries.filter(p => p.overallAdherence >= 90).length }}</span>
            <span class="stat-label">Excellente observance</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <div class="loading-spinner" *ngIf="loading">
    <mat-spinner></mat-spinner>
  </div>
</div>